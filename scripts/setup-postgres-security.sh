#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PostgreSQL

set -e

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PostgreSQL..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ SSL
mkdir -p secrets ssl

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
echo "üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–ª—å–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π..."
openssl rand -base64 32 > secrets/postgres_password.txt
openssl rand -base64 32 > secrets/pgadmin_password.txt
echo "admin@emailgenerator.local" > secrets/pgadmin_email.txt

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è PostgreSQL
echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
openssl req -x509 -newkey rsa:4096 -keyout ssl/postgres.key -out ssl/postgres.crt -days 365 -nodes \
  -subj "/C=RU/ST=Moscow/L=Moscow/O=EmailGenerator/OU=IT/CN=postgres"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod 600 ssl/postgres.key secrets/*.txt
chmod 644 ssl/postgres.crt

# –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f .env ]; then
    echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
    cp .env.example .env
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏!"
fi

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PostgreSQL –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: docker-compose up -d"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs postgres"
echo ""
echo "üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:"
echo "- PostgreSQL –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (127.0.0.1:5432)"
echo "- pgAdmin –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (127.0.0.1:8080)"
echo "- SSL –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
echo "- –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Docker secrets"
